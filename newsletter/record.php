<?php/*	Zählt wie oft ein Newsletter geöffnet wurde	Copyright (C) 2013 Sven Anacker, siehe n_hilfe.inc.php*/$record = new record();class record {	private $mysqli;	function __construct() {		// config importieren!		include_once( '../config.inc.php');		// mysqli öffnen		$this->mysqli = @new mysqli( $_SESSION['cfg_db_host'], $_SESSION['cfg_db_user'], $_SESSION['cfg_db_pass'], $_SESSION['cfg_db_name'] );//		mysqli_set_charset( $this->mysqli, 'utf8');		if (mysqli_connect_errno()) {    		printf("Connect failed: %s\n", mysqli_connect_error());    		exit();		}		// ist die Tabelle schon vorhanden?		$result = $this->mysqli->query( 'select nummer from newsletter_log LIMIT 1;' );		if ( $result === FALSE ) {			$this->createTable();		}		if ( $_GET['view'] == "yes" ) {			$this->view();		} elseif ( $_GET['readercount'] == "yes" ) {			$this->readerCount();		} else {			$this->sendGIF();		}		exit;	}	private function createTable() {		$this->mysqli->query( 'CREATE TABLE `newsletter_log` (														 `nummer` int(11) unsigned NOT NULL AUTO_INCREMENT,														 `user` varchar(220) DEFAULT NULL,														 `newsletter` int(11) unsigned DEFAULT NULL,														 `opened` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,														 PRIMARY KEY (`nummer`)													 	);' );	}	function readerCount() {		$newsletter = $this->mysqli->real_escape_string( $_GET['newsletter'] );		$result = $this->mysqli->query( 'select user		 																	from newsletter_log																			WHERE newsletter = ' . $newsletter . '																			GROUP BY user;' );		echo $result->num_rows;	}	function view() {		$newsletter = $this->mysqli->real_escape_string( $_GET['newsletter'] );		if ( $newsletter ) {			$filter[] = "newsletter = " . $newsletter;		}		if ( count( $filter ) ) {			$filterTxt = " AND " . implode( " AND ", $filter ) . " ORDER BY user";		} else {			$filterTxt = " ORDER BY newsletter, user LIMIT 500";		}//		echo $filterTxt;		$result = $this->mysqli->query( 'select newsletter, user, opened		 																	from newsletter_log																			WHERE user != "test@impgmbh.de"																			' . $filterTxt . ';' );		$user = "";		$i = 0;		while( $row = $result->fetch_object() ) {			if ( $user == $row->user ) {			} else {				$i++;				if ( $newsletter ) {					echo $row->user . ", geöffnet: " . $row->opened . "<br>";				} else {					echo "Newsletter " . $row->newsletter . " " . $row->user . ", geöffnet: " . $row->opened . "<br>";				}			}			$user = $row->user;		}		echo "<h4>" . $i . " Leser hat dieser Newsletter</h4>";	}	function sendGIF() {		//Begin the header output		header( 'Content-Type: image/gif' );		//Full URI to the image		$graphic_http = 'http://filestore.imp.gmbh/newsletter/blank.gif';		//Get the filesize of the image for headers		$filesize = filesize( 'blank.gif' );		// Datenbankeintrag erstellen		$this->user2db();		//Now actually output the image requested (intentionally disregarding if the database was affected)		header( 'Pragma: public' );		header( 'Expires: 0' );		header( 'Cache-Control: must-revalidate, post-check=0, pre-check=0' );		header( 'Cache-Control: private',false );		header( 'Content-Disposition: attachment; filename="blank.gif"' );		header( 'Content-Transfer-Encoding: binary' );		header( 'Content-Length: '.$filesize );		readfile( $graphic_http );	}	function user2db() {		// <img alt="" src="http://filestore.imp.gmbh/newsletter/record.php?user=youremail@email.com&newsletter=19" width="1" height="1" border="0" />		if ( !empty( $_GET['user'] ) & !empty( $_GET['newsletter'] ) ) {			$user = $this->mysqli->real_escape_string( $_GET['user'] );			$newsletter = $this->mysqli->real_escape_string( $_GET['newsletter'] );			$this->mysqli->query( 'insert into newsletter_log set			 												`user` = "' . $user . '",															`newsletter` = ' . $newsletter . ';' );		}	}}?>